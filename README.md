# Проект по анализу шахматных партий с применением методов машинного обучения
## Основная информация о проекте

Авторы:
Адилхан Санжар, БЭК212
Гусев Владислав, БЭК212
Семинарист:
Воропаев Роберт Ираклиевич

---------

### Общая информация по репозиторию

Ссылка на файлы с данными: https://disk.yandex.com/d/EGHi7eWtsn3Vvw
Объем файлов большой, поэтому они были выгружены в отдельную папку на гугл-диске
В репозитории на данный момент представлено 2 файла формата .ipynb, в которых содержится код для соответствующих разделов исследвоания:

1. Файл 'Parsing.ipynb' содержит код по преобразованию сырого фалйна с шахматными играми формата .pgn в несколько файлов .csv таблиц. Все эти файлы находятся в приложенной выше ссылке
2. Файл 'ForkliftCertified.ipynb' содержит код работы с полученными датасетами. Он включает минимальные преобразования, визуализацию и некоторые выводы о полученных данных

Также репозиторий включает папку с прочими материалами

---------


### Общая информация по датасету

1. Первичные данные

Изначальный датасет с играми был собран с сайта https://database.lichess.org, где данные представлены в формате .pgn.zst. .pgn - это формат шахматной нотации, в котором указаны данные игроков и ходы, причём 6% всех игр имеют оценку ходов шахматным движком Stockfish. Тут собраны датасеты по играм за каждый месяц начиная с января 2013 года. В ходе работы было установлено, что с имеющимися мощностями и доступным временем, необходимо выбирать наиболее укороченные датасеты, писать на них код, а потом переносить всё на большой датасет.
В ходе распаковки игрового файла .pgn.zst в .pgn его объем увеличивается в несколько раз (в данном исследовании с 48 MB до 237 MB). Был выбран датасет за Август 2013 года, содержащий в себе около 325,000 шахматных игр. На данном этапе была произведена только распаковка формата .zst с помощью архиватора PeaZip

2. Дальнейшее преобразование

На первом этапе парсинга игрового формата была применена библиотека pgn2data, с помощью которого все игры удалось за несколько часов преобразовать в 2 датасета (они представлены на Яндекс-Диске): один файл, содержащий ходы каждой партии - 'lichess_db_standard_rated_2013-08_moves.csv', и другой файл, содержащий общую информацию об игре - 'lichess_db_standard_rated_2013-08_game_info.csv'

После этого был произведен парсинг первичного датасета для выделения из него двух (пока что) важных признаков, которые впоследствии будут являтся основой для проверки гипотез и проведения машинного обучения: дебюты и оценки ходов в каждой игре. Для этого были применены различные методы. Код данного эатапа работы представлен в репозитории: 'Parsing.ipynb'. 

Одной из проблем датасета было то, что оценка ходов находилась только в 1650 играх из 325,000 - именно поэтому итоговый датасет был укорочен в соответствии с наличием %evals (оценками ходов). В дальнейшем, когда код будет готов на этом (маленьком) датасете - мы перенесём его на более большой.

Также было удалено большое количество колонок в файле с описанием игры

После всевозможных преобразований на выходе было получено два готовх датасета: 'upd_moves_df.csv' и 'upd_games_df.csv'

3. Содержание преобразованного датасета

* Датасет с описанием игр

Он содержит 1651 строку (количество игр) и 11 колонок (признаки):

1. game_id - ID игры, которое создалось в процессе парсинга

2. event - режим шахматной игры

В данном датасете он представлен тремя категориями: Blitz, Bullet и Classic. Также в датасете имеются как отдельные игры, так и игры в рамках чемпионатов

3. white - ник белого игрока

4. black - ник черного игрока

5. result - кто победил (1 - белые, 0 - черные)

6. white_elo - рейтинг белого игрока

7. black_elo - рейтинг черного игрока

8. eco - закодированное название дебюта

9. termination - Как игра закончилась (Истекло время или по ходу игры)

10. time_control - временной режим партии

11. op - название дебюта

* Датасет с ходами

Он содержит 65 колонок, основными из которых являются:

1. eval - оценка хода

2. piece - шахматная фигугра, которой делается ход

3. move_no_pair - порядковый номер хода (парный)

4. Количетсво оставшихся фигур каждого цвета после каждого хода

5. is_check, is_checkmate, is_gameover - отражает результат игры на текущем ходе


Другие колонки в дальнейшем могут понадобится для образования новых признаков

---------

### Визуализация

Данный раздел представлен в файле 'ForkliftCertified.ipynb'.

Что мы планируем визуализировать дальше?

----------

### Какие гипотезы мы будем проверять?

Имея данный датасет, можно придумать очень большое количество идей для гипотез. Большие датасеты (примерно с 2017 года) включают в себя данные по часам игроков во время партии, то есть каждый ход будет характеризоваться ещё и потраченным временем на обдумывание (%clk).

Таким образом, мы бы хотели проверить гипотезу, о том, что: 
1) Неопытные игроки тратят намного меньше времени на ход, чем профессионалы (например, имея изначально на часах 10 минут, партия может завершиться за 2 минуты)
2) Чем меньше времени остаётся у игрока - тем хуже он начинает играть. Как время влияет на оптимальность хода?

Это были гипотезы, связанные со временем. 

----------

### Какое машинное обучение будем делать?

Мы планируем обучить модель **линейной регрессии**, чтобы она по ходам в партии двух игроков определяла средний рейтинг матча (либо даже рейтинги двух игроков).
Самое сложное в этом деле - придумать признаки, потому что имея просто оценку ходов от Stockfish - сделать много не получится. 

У нас имеются следующие идеи по признакам:
1) Разделить партию на 3 части (дебют, миттеншпиль, эндшпиль). Очевидно, что профессионалы играют на равных в дебюте и середине и начинают ошибаться только под конец, когда как в низкорейтинговых матчах видны огромные колебания перевеса. Отсюда следует второй признак
2) Количество ходов, за которое закончилась партия. Опытные игроки никогда не проиграют за 3 хода. Чем больше рейтинг игроков, тем они внимательнее, и, соответственно, партия становится длиннее.
3) Данные с часов. Например, можно добавить признак: "процент израсходованного времени". То есть, если у человека было 10 минут, а партия закончилась, когда у игрока оставалось 9 минут, то процент израсходованного времени - 10%. Это очень мало, обычно такие показатели у слабых игроков.
Пока на этом всё, во время обучения модели придумаем что-то ещё.

Касаемо первого пункта: мы планируем классифицировать ходы так (примерно): 
1) Теоретический ход - ход, повторяющий какой-то дебют. Обычно у неопытных игроков теоретические ходы заканчиваются после третьего хода, а у профессионалов могут занять 10 ходов.
2) Неточность
3) Ошибка
4) Зевок

Такая классификация поможет понять, какие ходы делают игроки того или иного рейтинга.
